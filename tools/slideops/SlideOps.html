<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SlideOps</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0c1730;
      --text:#e7eefc;
      --muted:#a9b8d6;
      --line:#1f2e4f;
      --chip:#1a2a4d;
      --warn:#ffcc66;
      --crit:#ff6b6b;
      --ok:#5ee7a2;
      --fix:#7aa8ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% 0%, #162a55 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.70));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px 18px;}
    h1{font-size:18px; margin:0 0 6px 0; letter-spacing:.2px}
    .mini{color:var(--muted); font-weight:500}
    .sub{color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch}
    .card{
      background: linear-gradient(180deg, rgba(15,27,51,.95), rgba(12,23,48,.95));
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:12px;
      flex:1 1 240px;
      min-width:220px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .metric{display:flex; align-items:baseline; justify-content:space-between; gap:10px}
    .metric .k{color:var(--muted); font-size:12px}
    .metric .v{font-size:18px; font-weight:650}
    .metric small{color:var(--muted); font-weight:500}
    .tabs{display:flex; gap:8px; margin-top:12px}
    .tab{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{background:rgba(122,168,255,.20); border-color:rgba(122,168,255,.35)}
    .subtabs{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .subtabs .tab{padding:6px 9px; font-size:12px}
    main{max-width:1200px; margin:0 auto; padding:16px 18px 40px;}
    .panel{
      background: rgba(15,27,51,.92);
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      margin-bottom:14px;
    }
    .panel h2{margin:0 0 10px 0; font-size:15px}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--panel);
      color:var(--text);
      outline:none;
    }
    select option{
      background: var(--panel);
      color: var(--text);
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(122,168,255,.60); box-shadow: 0 0 0 3px rgba(122,168,255,.15)}
    textarea{min-height:108px; resize:vertical}
    textarea#eAiNotes:focus{border-color: rgba(255,204,102,.50); box-shadow: 0 0 0 3px rgba(255,204,102,.18)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{background: rgba(255,255,255,.10)}
    .primary{background: rgba(122,168,255,.25); border-color: rgba(122,168,255,.40)}
    .danger{background: rgba(255,107,107,.18); border-color: rgba(255,107,107,.40)}
    .ghost{background: transparent}
    button:disabled{opacity:.45; cursor:not-allowed}
    table{width:100%; border-collapse: collapse; font-size:13px}
    thead th{
      position:sticky; top:0;
      background: rgba(11,18,32,.92);
      text-align:left; padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    tbody td{padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;
      white-space:nowrap;
    }
    .p0{background: rgba(255,107,107,.20); border-color: rgba(255,107,107,.35)}
    .p1{background: rgba(255,204,102,.18); border-color: rgba(255,204,102,.32)}
    .p2{background: rgba(122,168,255,.16); border-color: rgba(122,168,255,.28)}
    .p3{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}
    .p4{background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.08); opacity:.85}
    .p5{background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.07); opacity:.75}
    .conf-low{background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.26)}
    .conf-mod{background: rgba(255,204,102,.12); border-color: rgba(255,204,102,.24)}
    .conf-high{background: rgba(94,231,162,.12); border-color: rgba(94,231,162,.24)}
    .cog-low{background: rgba(94,231,162,.12); border-color: rgba(94,231,162,.24)}
    .cog-mod{background: rgba(122,168,255,.12); border-color: rgba(122,168,255,.24)}
    .cog-high{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.24)}
    .state-critical{background: rgba(255,107,107,.20); border-color: rgba(255,107,107,.35)}
    .state-fix{background: rgba(122,168,255,.16); border-color: rgba(122,168,255,.28)}
    .state-done{background: rgba(94,231,162,.16); border-color: rgba(94,231,162,.28)}
    .pillbar{display:flex; gap:8px; flex-wrap:wrap}
    .pillbar button{padding:5px 8px; border-radius:999px}
    .pillbar button.active{background: rgba(122,168,255,.22); border-color: rgba(122,168,255,.45)}
    .muted{color:var(--muted)}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .footer{color:var(--muted); font-size:12px; text-align:center; margin-top:18px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); padding:2px 6px; border-radius:8px;}

    /* Legend + backlog */
    details{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(12,23,48,.55);
      border-radius:12px;
      padding:10px;
    }
    details summary{cursor:pointer; color:var(--text); font-weight:650}
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px
    }
    .legend .item{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:8px 10px;
      min-width:220px;
      flex: 1 1 220px;
    }
    .legend .item .t{font-weight:650; margin-bottom:6px}
    .board{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 1100px){.board{grid-template-columns: 1fr 1fr}}
    @media (max-width: 700px){.board{grid-template-columns: 1fr}}
    .col{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(12,23,48,.55);
      border-radius:14px;
      padding:10px;
      min-height:220px;
    }
    .colHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .colHeader .name{font-weight:700}
    .colHeader .count{color:var(--muted); font-size:12px}
    .colBody{min-height:140px}
    .cardItem{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:12px;
      padding:8px 9px;
      margin-bottom:8px;
      cursor:pointer;
    }
    .cardItem:hover{background: rgba(255,255,255,.06)}
    .cardItem.dragging{opacity:.6}
    .minirow{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .small{font-size:12px; color:var(--muted)}
    .dropHint{
      border:1px dashed rgba(122,168,255,.35);
      background: rgba(122,168,255,.08);
    }
    /* Indicador de arquivo */
    .file-indicator{
      font-size:11px;
      padding:4px 10px;
      border-radius:6px;
      display:inline-block;
      margin-left:10px;
      font-weight:600;
    }
    .file-indicator.connected{
      background: rgba(94,231,162,.20);
      color: var(--ok);
      border: 1px solid rgba(94,231,162,.35);
    }
    .file-indicator.disconnected{
      background: rgba(255,107,107,.20);
      color: var(--crit);
      border: 1px solid rgba(255,107,107,.35);
    }
    .file-indicator.saving{
      background: rgba(122,168,255,.20);
      color: var(--fix);
      border: 1px solid rgba(122,168,255,.35);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex; align-items:center; flex-wrap:wrap; gap:8px;">
        <h1>SlideOps</h1>
        <span id="fileIndicator" class="file-indicator disconnected">Sem arquivo</span>
      </div>
      <div class="sub">Ctrl+S salva no arquivo. Vincule um JSON em pasta sincronizada (OneDrive/Dropbox). Auto-save grava nele (~700‚ÄØms). Abra o <strong>mesmo</strong> arquivo no outro PC ‚Üí mesma tela (ex.: 3 aqui ‚Üí 3 l√°; +5 l√° ‚Üí 8; volta aqui, sincroniza e abre ‚Üí 8).</div>

      <div class="row" style="margin-top:12px">
        <div class="card">
          <div class="metric"><div class="k">P0 done (GRADE)</div><div class="v" id="mGradeP0">‚Äî</div></div>
          <div class="hint" id="mGradeHint">‚Äî</div>
        </div>
        <div class="card">
          <div class="metric"><div class="k">P0 done (OSTEO)</div><div class="v" id="mOsteoP0">‚Äî</div></div>
          <div class="hint" id="mOsteoHint">‚Äî</div>
        </div>
        <div class="card">
          <div class="metric"><div class="k">Cr√≠ticos abertos</div><div class="v" id="mCritical">‚Äî</div></div>
          <div class="hint">Estado = Critical. √â o que entra no bloco #1.</div>
        </div>
        <div class="card">
          <div class="metric"><div class="k">Checado / Appraisal</div><div class="v" id="mQA">‚Äî</div></div>
          <div class="hint">Boxes "Conte√∫do checado" e "Critical appraisal".</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="backlog" type="button">Backlog</button>
        <button class="tab" data-tab="slides" type="button">Slides</button>
        <button class="tab" data-tab="study" type="button">Estudo</button>
        <button class="tab" data-tab="changelog" type="button">Changelog</button>
        <button class="tab" data-tab="export" type="button">Backup</button>
      </div>
    </div>
  </header>

  <main>
    <!-- BACKLOG TAB -->
    <section class="panel" id="tab-backlog">
      <h2>0) Backlog visual (por dia + dificuldade) ‚Äî arrastar e soltar</h2>

      <details>
        <summary>Legenda P0‚ÄìP5 (para n√£o misturar escopo com triagem)</summary>
        <div class="legend">
          <div class="item">
            <div class="t"><span class="chip p0">P0</span> Entrega m√≠nima defens√°vel</div>
            <div class="small">Precisa estar apresent√°vel e correto. Sem "TBD" que impe√ßa fala. Refer√™ncia m√≠nima quando h√° claim factual importante.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip p1">P1</span> Qualidade / andragogia / teoria de slides</div>
            <div class="small">Refino pedag√≥gico, narrativa, ritmo, carga cognitiva, microdesign. N√£o deve bloquear o P0.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip p2">P2</span> Melhorias √∫teis</div>
            <div class="small">Melhora o produto, mas pode ficar para depois sem risco grande.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip p3">P3</span> Backlog comum</div>
            <div class="small">Ideias e pend√™ncias n√£o cr√≠ticas.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip p4">P4</span> Nice-to-have</div>
            <div class="small">S√≥ entra se sobrar tempo (ou para aprender sem afetar o prazo).</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip p5">P5</span> N√£o fazer agora</div>
            <div class="small">Congelado/ignorado. Evita looping.</div>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Triagem operacional √© o campo <span class="kbd">Estado</span> (Critical/NeedsFix/Done). P-level √© escopo/qualidade.</div>
      </details>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Filtro de deck</label>
          <select id="bDeck">
            <option value="ALL">Todos</option>
            <option value="GRADE">GRADE</option>
            <option value="OSTEO">OSTEO</option>
          </select>
          <div class="hint">Dica: use <span class="kbd">ALL</span> para enxergar o sistema inteiro; use deck para executar.</div>
        </div>
        <div>
          <label>Mostrar slides Done</label>
          <select id="bShowDone">
            <option value="No">N√£o</option>
            <option value="Yes">Sim</option>
          </select>
          <div class="hint">Backlog geralmente √© o que ainda exige trabalho. Done pode poluir.</div>
        </div>
      </div>

      <div class="board" style="margin-top:12px">
        <div class="col" data-plan="Today">
          <div class="colHeader"><div class="name">Hoje</div><div class="count" id="cToday">‚Äî</div></div>
          <div class="colBody" id="col-Today"></div>
        </div>
        <div class="col" data-plan="Tomorrow">
          <div class="colHeader"><div class="name">Amanh√£</div><div class="count" id="cTomorrow">‚Äî</div></div>
          <div class="colBody" id="col-Tomorrow"></div>
        </div>
        <div class="col" data-plan="ThisWeek">
          <div class="colHeader"><div class="name">Esta semana</div><div class="count" id="cThisWeek">‚Äî</div></div>
          <div class="colBody" id="col-ThisWeek"></div>
        </div>
        <div class="col" data-plan="Later">
          <div class="colHeader"><div class="name">Depois</div><div class="count" id="cLater">‚Äî</div></div>
          <div class="colBody" id="col-Later"></div>
        </div>
      </div>
      <div class="hint" style="margin-top:10px">Arraste cards entre colunas para planejar. Clique no card para editar. Dificuldade = 1 (f√°cil) a 5 (dif√≠cil).</div>
    </section>

    <!-- SLIDES TAB -->
    <section class="panel" id="tab-slides" style="display:none">
      <h2>1) Matriz de slides (audit√°vel)</h2>

      <div class="subtabs" aria-label="Deck tabs (slides)">
        <button class="tab active" data-decktab="slides" data-deck="GRADE" type="button">GRADE</button>
        <button class="tab" data-decktab="slides" data-deck="OSTEO" type="button">OSTEO</button>
        <button class="tab" data-decktab="slides" data-deck="ALL" type="button">Todos</button>
      </div>

      <details>
        <summary>Legenda r√°pida (DoD P0 + estados)</summary>
        <div class="legend">
          <div class="item">
            <div class="t"><span class="chip p0">DoD P0 (slide)</span></div>
            <div class="small">Mensagem clara ‚Ä¢ zero TBD impeditivo ‚Ä¢ refer√™ncia m√≠nima em claims importantes ‚Ä¢ layout sem quebras ‚Ä¢ d√° para apresentar ao vivo.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip state-critical">Critical</span></div>
            <div class="small">Bloqueia apresentar. Vai para o bloco #1.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip state-fix">NeedsFix</span></div>
            <div class="small">Melhor√°vel. N√£o deve impedir a apresenta√ß√£o se P0 est√° ok.</div>
          </div>
          <div class="item">
            <div class="t"><span class="chip state-done">Done</span></div>
            <div class="small">Congelado. Evite reabrir (a menos que seja erro factual).</div>
          </div>
        </div>
      </details>

      <div style="margin-top:12px">
        <div class="hint" style="margin-bottom:10px;">
          <strong>Importar:</strong> Cria slides novos do <span class="kbd">_list.txt</span>. L√™ coment√°rios HTML invis√≠veis para preencher apenas: t√≠tulo, anchor e coment√°rios/boas pr√°ticas. Slides existentes s√£o preservados (n√£o perde metadados).<br>
          <strong>Sincronizar:</strong> Atualiza n√∫meros baseado no <span class="kbd">_list.txt</span> e l√™ coment√°rios HTML para atualizar apenas: t√≠tulo, anchor e coment√°rios/boas pr√°ticas. Mant√©m todos os outros metadados do SlideOps (P, estado, plan, difficulty, notas, confian√ßa, etc.). N√£o cria novos slides.
        </div>
        <div class="panel" style="background: rgba(255,204,102,.15); border:1px solid rgba(255,204,102,.3); margin-bottom:10px;">
          <div style="font-weight:600; margin-bottom:6px;">‚ö†Ô∏è Para Agentes IA:</div>
          <div style="font-size:13px; line-height:1.5;">
            <strong>SEMPRE adiciona coment√°rio invis√≠vel</strong> nos slides HTML: <span class="kbd"><!-- SlideOps: title="..." anchor="..." aiTips="..." --></span><br>
            Apenas <strong>title, anchor e aiTips</strong> v√™m dos coment√°rios HTML. P, state, plan, difficulty s√£o editados no SlideOps.<br>
            Sem coment√°rio, os slides aparecem sem t√≠tulo. Ver <span class="kbd">tools/slideops/README.md</span> e <span class="kbd">docs/AI_HANDOFF_RULES.md</span>.
          </div>
        </div>
        <div class="actions">
          <select id="genDeck" style="width:auto;">
            <option value="GRADE">GRADE</option>
            <option value="OSTEO">OSTEO</option>
          </select>
          <button id="btnImportFromDeck" class="primary">Importar slides da apresenta√ß√£o</button>
          <button id="btnSyncNumbers" class="ghost">Sincronizar n√∫meros (mant√©m metadados)</button>
          <button id="btnClearAll" class="danger">Zerar tudo (cuidado)</button>
        </div>
      </div>

        <div>
          <label>Filtros</label>
          <select id="fDeck" style="display:none">
            <option value="ALL">Todos decks</option>
            <option value="GRADE">GRADE</option>
            <option value="OSTEO">OSTEO</option>
          </select>
          <div style="margin-top:6px">
            <select id="fSort">
              <option value="priority">Prioridade</option>
              <option value="state">Triagem</option>
              <option value="modified">√öltima modifica√ß√£o</option>
              <option value="plan">Plano (dia)</option>
              <option value="slide">N√∫mero do slide</option>
            </select>
          </div>
          <div class="hint" style="margin-top:8px">Deck: use GRADE / OSTEO / Todos acima. Ordenar: prioridade, triagem, data, plano ou n√∫mero.</div>
        </div>
      </div>

      <div style="margin-top:14px; overflow:auto; max-height:380px;">
        <table>
          <thead>
            <tr>
              <th>Deck</th>
              <th>#</th>
              <th>T√≠tulo curto</th>
              <th>P</th>
              <th>Estado</th>
              <th>Plano</th>
              <th>Dif</th>
              <th>Conf</th>
              <th>Carga</th>
              <th>Last mod</th>
              <th>Checado</th>
              <th>Appraisal</th>
              <th>Editar</th>
            </tr>
          </thead>
          <tbody id="slidesBody"></tbody>
        </table>
      </div>

      <div class="panel" style="margin-top:12px; background: rgba(12,23,48,.85)">
        <h2 style="margin-bottom:8px">Editor r√°pido</h2>
        <div class="grid">
          <div>
            <div class="two">
              <div>
                <label>Slide selecionado</label>
                <input id="eKey" disabled placeholder="Clique em Editar numa linha acima" />
              </div>
              <div>
                <label>T√≠tulo curto</label>
                <input id="eTitle" placeholder="Ex: NNT por droga (prim√°ria vs secund√°ria)" />
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>P-level (P0‚ÄìP5)</label>
                <select id="eP">
                  <option>P0</option><option>P1</option><option>P2</option><option>P3</option><option>P4</option><option>P5</option>
                </select>
              </div>
              <div>
                <label>Estado (triagem)</label>
                <div class="pillbar">
                  <button id="eCritical" type="button">Critical</button>
                  <button id="eNeedsFix" type="button">NeedsFix</button>
                  <button id="eDone" type="button">Done</button>
                </div>
                <div class="hint">Critical = bloqueia apresentar ‚Ä¢ NeedsFix = melhora ‚Ä¢ Done = congelado.</div>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Plano (dia)</label>
                <select id="ePlan">
                  <option value="Today">Today</option>
                  <option value="Tomorrow">Tomorrow</option>
                  <option value="ThisWeek">ThisWeek</option>
                  <option value="Later">Later</option>
                </select>
              </div>
              <div>
                <label>Dificuldade (1‚Äì5)</label>
                <select id="eDiff">
                  <option value="1">1 (f√°cil)</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5 (dif√≠cil)</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Conte√∫do checado (sim/n√£o)</label>
                <select id="eChecked"><option value="No">No</option><option value="Yes">Yes</option></select>
              </div>
              <div>
                <label>Confrontado com critical appraisal (sim/n√£o)</label>
                <select id="eAppraisal"><option value="No">No</option><option value="Yes">Yes</option></select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Confian√ßa (baixa / moderada / alta)</label>
                <div class="pillbar" id="confPills">
                  <button id="eConfLow" type="button">Baixa</button>
                  <button id="eConfMod" type="button">Moderada</button>
                  <button id="eConfHigh" type="button">Alta</button>
                </div>
                <div class="hint">Seu n√≠vel de seguran√ßa no conte√∫do/claim.</div>
              </div>
              <div>
                <label>Carga cognitiva (baixa / moderada / alta)</label>
                <div class="pillbar" id="cogPills">
                  <button id="eCogLow" type="button">Baixa</button>
                  <button id="eCogMod" type="button">Moderada</button>
                  <button id="eCogHigh" type="button">Alta</button>
                </div>
                <div class="hint">Alta = prov√°vel dividir em 2 slides ou simplificar.</div>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>√Çncora EBM (1 linha)</label>
              <input id="eAnchor" placeholder="Mensagem + n√∫mero absoluto (NNT/ARR) + refer√™ncia curta" />
              <div class="hint">Serve para travar "conte√∫do m√≠nimo defens√°vel" sem reescrever o deck inteiro.</div>
            </div>

            <div style="margin-top:10px">
              <label>Objetivo do slide (1 linha)</label>
              <input id="eObjective" placeholder="O que este slide precisa fazer na decis√£o do p√∫blico?" />
            </div>

            <div style="margin-top:10px">
              <label>Narrativa & intera√ß√µes (1‚Äì2 linhas)</label>
              <input id="eNarrative" placeholder="Como voc√™ vai conduzir a fala + pergunta/checagem r√°pida?" />
            </div>

            <div class="actions" style="margin-top:10px">
              <button id="btnCopyBrief" class="ghost" disabled>Copiar brief (para AI)</button>
              <span class="hint" id="briefHint" style="margin:0">‚Äî</span>
            </div>
          </div>

          <div>
            <label>Coment√°rios (voc√™)</label>
            <textarea id="eMyNotes" placeholder="Observa√ß√µes r√°pidas: o que falta / o que est√° bom / o que cortar"></textarea>

            <div style="margin-top:10px; padding:12px; background:rgba(94,231,162,.08); border:1px solid rgba(94,231,162,.20); border-radius:4px;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <label style="margin:0; font-weight:600; color:rgba(94,231,162,.85);">üìù Dados do HTML (coment√°rios invis√≠veis - autom√°tico)</label>
              </div>
              <div id="htmlCommentsBox" style="font-size:13px; line-height:1.5; color:rgba(255,255,255,.85); min-height:80px; padding:12px; background:rgba(94,231,162,.06); border:1px solid rgba(94,231,162,.15); border-radius:3px; white-space:pre-wrap;">
                <em style="color:rgba(255,255,255,.5);">Nenhum coment√°rio encontrado no HTML</em>
              </div>
              <div class="hint" style="margin-top:6px; font-size:12px;">Estes dados v√™m <strong>automaticamente</strong> dos coment√°rios invis√≠veis no ficheiro HTML do slide (title, anchor, aiTips).<br><strong>Nota:</strong> Prioridade, Estado, Plano, Dificuldade, Confian√ßa, Checado e Appraisal s√£o editados por voc√™ no SlideOps, n√£o v√™m do HTML.</div>
            </div>

            <div style="margin-top:10px">
              <div class="actions" style="justify-content:space-between">
                <label style="margin:0; color:rgba(255,204,102,.85);">üí¨ Coment√°rios (AI) ‚Äî template de qualidade (preenchido manualmente)</label>
                <button id="btnInsertAiTpl" class="ghost">Inserir template</button>
              </div>
              <textarea id="eAiNotes" placeholder="Cole aqui a revis√£o da AI seguindo o protocolo (ap√≥s colar o slide no chat/Claude)" style="background: rgba(255,204,102,.08); border-color: rgba(255,204,102,.25); min-height: 140px;"></textarea>
              <div class="hint">Template sugere: Claim ‚Üí Evidence ‚Üí Effect size ‚Üí Certainty ‚Üí Applicability ‚Üí Suggested slide line.<br><strong>Diferente dos coment√°rios invis√≠veis:</strong> Este campo √© preenchido <strong>manualmente</strong> por voc√™ ap√≥s colar o slide no chat/Claude.</div>
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button id="btnSave" class="primary" disabled>Salvar altera√ß√µes</button>
          <button id="btnCancel" class="ghost" disabled>Cancelar</button>
          <span class="muted" id="saveStatus">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- STUDY TAB -->
    <section class="panel" id="tab-study" style="display:none">
      <h2>2) Matriz de estudo (leitura ‚Üí cart√µes ‚Üí aplica√ß√£o)</h2>

      <div class="subtabs" aria-label="Deck tabs (study)">
        <button class="tab active" data-decktab="study" data-deck="GRADE" type="button">GRADE</button>
        <button class="tab" data-decktab="study" data-deck="OSTEO" type="button">OSTEO</button>
        <button class="tab" data-decktab="study" data-deck="ALL" type="button">Todos</button>
      </div>

      <div class="grid">
        <div>
          <label>Novo item de estudo</label>
          <div class="two">
            <select id="sDeck">
              <option value="GRADE">GRADE</option>
              <option value="OSTEO">OSTEO</option>
            </select>
            <input id="sRange" placeholder="Slides (ex: 12-14) ou t√≥pico (ex: NNT estatinas)" />
          </div>
          <div style="margin-top:10px">
            <label>Material (link/arquivo/nota)</label>
            <input id="sMaterial" placeholder="URL, nome do PDF, guideline, etc." />
          </div>
          <div class="two" style="margin-top:10px">
            <div>
              <label>Status</label>
              <select id="sStatus">
                <option>ToRead</option>
                <option>Extracted</option>
                <option>Applied</option>
              </select>
            </div>
            <div>
              <label>Cards gerados (n√∫mero)</label>
              <input id="sCards" type="number" min="0" value="0" />
            </div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button id="btnAddStudy" class="primary">Adicionar</button>
            <button id="btnClearStudy" class="danger">Zerar estudos</button>
          </div>
          <div class="hint">Regra: leitura s√≥ conta quando vira cart√£o ou vira slide. "ToRead" demais vira backlog.</div>
        </div>

        <div>
          <label>Reflex√µes / critical appraisal / aplica√ß√£o</label>
          <textarea id="sNotes" placeholder="O que isso muda? Qual efeito absoluto? Qual certeza? Qual aplicabilidade?"></textarea>
          <div class="hint">Dica: transforme reflex√£o em 1‚Äì2 "cards" aplic√°veis (√¢ncora EBM).</div>
        </div>
      </div>

      <div style="margin-top:14px; overflow:auto; max-height:360px;">
        <table>
          <thead>
            <tr>
              <th>Deck</th>
              <th>Alvo</th>
              <th>Material</th>
              <th>Status</th>
              <th>Cards</th>
              <th>Last mod</th>
              <th>Editar</th>
            </tr>
          </thead>
          <tbody id="studyBody"></tbody>
        </table>
      </div>

      <div class="panel" style="margin-top:12px; background: rgba(12,23,48,.85)">
        <h2 style="margin-bottom:8px">Editor de estudo</h2>
        <div class="grid">
          <div>
            <label>ID selecionado</label>
            <input id="seId" disabled />
            <div class="two" style="margin-top:10px">
              <div>
                <label>Status</label>
                <select id="seStatus">
                  <option>ToRead</option><option>Extracted</option><option>Applied</option>
                </select>
              </div>
              <div>
                <label>Cards gerados</label>
                <input id="seCards" type="number" min="0" />
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Reflex√µes / aplica√ß√£o</label>
              <textarea id="seNotes"></textarea>
            </div>
          </div>
          <div>
            <label>Material</label>
            <input id="seMaterial" />
            <div style="margin-top:10px">
              <label>Alvo (slides ou t√≥pico)</label>
              <input id="seRange" />
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="btnSaveStudy" class="primary" disabled>Salvar</button>
              <button id="btnDeleteStudy" class="danger" disabled>Excluir</button>
              <span class="muted" id="studyStatus">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHANGELOG TAB -->
    <section class="panel" id="tab-changelog" style="display:none">
      <h2>Changelog</h2>

      <div class="tabs" style="margin-bottom:16px;">
        <button class="tab active" data-changelog-tab="by-day" type="button">Por dia</button>
        <button class="tab" data-changelog-tab="by-slide" type="button">Por slide</button>
      </div>

      <!-- Por dia -->
      <div id="changelog-by-day">
        <div class="panel" style="background: rgba(12,23,48,.85);">
          <div id="changelogDayBody"></div>
        </div>
      </div>

      <!-- Por slide -->
      <div id="changelog-by-slide" style="display:none;">
        <div class="grid">
          <div>
            <label>Filtrar por deck</label>
            <select id="changelogDeckFilter">
              <option value="ALL">Todos</option>
              <option value="GRADE">GRADE</option>
              <option value="OSTEO">OSTEO</option>
            </select>
          </div>
          <div>
            <label>Filtrar por slide</label>
            <input id="changelogSlideFilter" placeholder="Ex: GRADE#1 ou OSTEO#5" />
          </div>
        </div>
        <div class="panel" style="background: rgba(12,23,48,.85); margin-top:12px;">
          <div id="changelogSlideBody"></div>
        </div>
      </div>
    </section>

    <!-- EXPORT TAB -->
    <section class="panel" id="tab-export" style="display:none">
      <h2>3) Backup / 2 computadores (sem servidor)</h2>

      <div class="grid">
        <div>
          <label>Backup manual</label>
          <div class="actions">
            <button id="btnExport" class="primary">Baixar JSON</button>
            <input id="fileImport" type="file" accept="application/json" />
          </div>
          <div class="hint">Se for usar Git: exporte como <span class="kbd">slideops_data.json</span>, commit e push. No outro PC: pull e importe.</div>
        </div>
        <div>
          <label>Sincronizar com slides HTML</label>
          <div class="actions">
            <button id="btnExportSyncPlan" class="primary">Exportar plano de sincroniza√ß√£o</button>
          </div>
          <div class="hint">Gera JSON com a ordem atual. Execute <span class="kbd">scripts/sync-slides-from-slideops.js</span> para renomear ficheiros e atualizar <span class="kbd">_list.txt</span>.</div>
        </div>
        <div>
          <label>Vincular arquivo JSON (recomendado para 2 PCs)</label>
          <div class="actions">
            <button id="btnOpenData" class="primary">Abrir JSON existente</button>
            <button id="btnCreateData" class="ghost">Criar JSON novo</button>
            <button id="btnSaveData" class="ghost" disabled>Salvar agora</button>
            <button id="btnDisconnect" class="ghost" disabled>Desconectar</button>
          </div>
          <div class="actions" style="margin-top:8px">
            <label style="margin:0"><input type="checkbox" id="chkAutoSave" checked /> Auto-salvar</label>
            <span class="muted" id="fileStatus">Sem arquivo vinculado.</span>
          </div>
          <div class="hint">Chrome/Edge (File System Access). Use <strong>um</strong> JSON numa pasta sincronizada: auto-save grava nele; abra o mesmo arquivo em cada PC para ver sempre os mesmos dados.</div>
        </div>
      </div>

      <div class="footer">SlideOps ‚Äî Ctrl+S para salvar ‚Ä¢ local, r√°pido, audit√°vel.</div>
    </section>
  </main>

<script>
(() => {
  const LS_KEY = "slideops_lite_v1"; // mant√©m compatibilidade com v1
  const nowISO = () => new Date().toISOString();
  const fmt = (iso) => {
    if(!iso) return "‚Äî";
    const d = new Date(iso);
    return d.toLocaleString(undefined, {year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"});
  };

  const DEFAULT = { slides: [], studies: [], changelog: { byDay: [], bySlide: {} } };

  const upgrade = (data) => {
    // garante campos novos sem quebrar dados antigos
    if (!data.changelog) {
      data.changelog = { byDay: [], bySlide: {} };
    }
    if(!data || typeof data !== "object") return structuredClone(DEFAULT);
    if(!Array.isArray(data.slides)) data.slides = [];
    if(!Array.isArray(data.studies)) data.studies = [];
    for(const s of data.slides){
      if(!s.key && s.deck && (s.num || s.num===0)) s.key = `${s.deck}#${s.num}`;
      if(!s.p) s.p = "P1";
      if(!s.state) s.state = "NeedsFix";
      if(!s.checked) s.checked = "No";
      if(!s.appraisal) s.appraisal = "No";
      if(!s.objective) s.objective = "";
      if(!s.narrative) s.narrative = "";
      if(!s.myNotes) s.myNotes = "";
      if(!s.aiNotes) s.aiNotes = "";
      if(!s.title) s.title = "";
      if(!s.lastModified) s.lastModified = nowISO();
      // novos campos
      if(!s.plan) s.plan = "ThisWeek";
      if(!s.difficulty) s.difficulty = 3;
      if(!s.anchor) s.anchor = "";
      if(!s.htmlComments) s.htmlComments = ""; // Coment√°rios/boas pr√°ticas que v√™m do HTML
      if(!s.confidence) s.confidence = "Moderate";
      if(!s.cogLoad) s.cogLoad = "Moderate";
    }
    return data;
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return upgrade(structuredClone(DEFAULT));
      return upgrade(JSON.parse(raw));
    } catch { return upgrade(structuredClone(DEFAULT)); }
  };

  let DATA = load();
  let selectedKey = null;

  // ---------- changelog ----------
  const todayKey = () => new Date().toISOString().split('T')[0]; // YYYY-MM-DD

  const logChange = (slideKey, field, oldValue, newValue, action = "updated") => {
    if (!DATA.changelog) {
      DATA.changelog = { byDay: [], bySlide: {} };
    }
    const slide = findSlide(slideKey);
    if (!slide) return;

    const timestamp = nowISO();
    const dateKey = todayKey();
    const change = {
      timestamp,
      slideKey,
      deck: slide.deck,
      num: slide.num,
      title: slide.title || "",
      field,
      oldValue: String(oldValue || ""),
      newValue: String(newValue || ""),
      action
    };

    // Adicionar ao changelog por dia
    let dayEntry = DATA.changelog.byDay.find(d => d.date === dateKey);
    if (!dayEntry) {
      dayEntry = { date: dateKey, changes: [] };
      DATA.changelog.byDay.push(dayEntry);
      DATA.changelog.byDay.sort((a, b) => b.date.localeCompare(a.date));
    }
    dayEntry.changes.push(change);
    dayEntry.changes.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

    // Adicionar ao changelog por slide
    if (!DATA.changelog.bySlide[slideKey]) {
      DATA.changelog.bySlide[slideKey] = [];
    }
    DATA.changelog.bySlide[slideKey].push(change);
    if (DATA.changelog.bySlide[slideKey].length > 50) {
      DATA.changelog.bySlide[slideKey] = DATA.changelog.bySlide[slideKey].slice(-50);
    }
  };

  const renderChangelogByDay = () => {
    const body = document.getElementById("changelogDayBody");
    if (!body) return;
    if (!DATA.changelog || !DATA.changelog.byDay || DATA.changelog.byDay.length === 0) {
      body.innerHTML = "<div class='hint'>Nenhuma mudan√ßa registrada ainda.</div>";
      return;
    }

    let html = "";
    for (const day of DATA.changelog.byDay) {
      const date = new Date(day.date + "T00:00:00");
      const dateStr = date.toLocaleDateString("pt-BR", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      html += `<div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--line);">`;
      html += `<h3 style="margin:0 0 12px 0; font-size:16px; font-weight:650;">${dateStr}</h3>`;
      html += `<div style="display:flex; flex-direction:column; gap:8px;">`;
      
      for (const change of day.changes) {
        const time = new Date(change.timestamp).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        const slideLabel = `${change.deck} #${change.num}${change.title ? `: ${escapeHtml(change.title)}` : ""}`;
        let changeText = "";
        
        if (change.action === "created") {
          changeText = `Criado: ${slideLabel}`;
        } else if (change.field) {
          const fieldLabels = {
            title: "T√≠tulo", p: "P-level", state: "Estado", plan: "Plano",
            difficulty: "Dificuldade", confidence: "Confian√ßa", cogLoad: "Carga cognitiva",
            anchor: "Anchor", objective: "Objective", narrative: "Narrative",
            myNotes: "My Notes", aiNotes: "AI Notes", checked: "Checked", appraisal: "Appraisal"
          };
          const fieldLabel = fieldLabels[change.field] || change.field;
          changeText = `${slideLabel} ‚Üí ${fieldLabel}: "${escapeHtml(change.oldValue)}" ‚Üí "${escapeHtml(change.newValue)}"`;
        } else {
          changeText = `${slideLabel} ‚Üí ${change.action}`;
        }
        
        html += `<div style="padding:8px; background:rgba(255,255,255,.03); border-radius:6px; font-size:13px;">`;
        html += `<span style="color:var(--muted); margin-right:8px;">${time}</span>`;
        html += `<span>${changeText}</span>`;
        html += `</div>`;
      }
      html += `</div></div>`;
    }
    body.innerHTML = html;
  };

  const renderChangelogBySlide = () => {
    const body = document.getElementById("changelogSlideBody");
    if (!body) return;
    const deckFilter = document.getElementById("changelogDeckFilter")?.value || "ALL";
    const slideFilter = (document.getElementById("changelogSlideFilter")?.value || "").trim().toUpperCase();

    if (!DATA.changelog || !DATA.changelog.bySlide) {
      body.innerHTML = "<div class='hint'>Nenhuma mudan√ßa registrada ainda.</div>";
      return;
    }

    let slides = Object.keys(DATA.changelog.bySlide);
    if (deckFilter !== "ALL") {
      slides = slides.filter(key => key.startsWith(deckFilter + "#"));
    }
    if (slideFilter) {
      slides = slides.filter(key => key.includes(slideFilter));
    }

    if (slides.length === 0) {
      body.innerHTML = "<div class='hint'>Nenhum slide encontrado com os filtros selecionados.</div>";
      return;
    }

    let html = "";
    for (const slideKey of slides.sort()) {
      const changes = DATA.changelog.bySlide[slideKey];
      const slide = findSlide(slideKey);
      const slideLabel = slide ? `${slide.deck} #${slide.num}${slide.title ? `: ${escapeHtml(slide.title)}` : ""}` : slideKey;
      
      html += `<div style="margin-bottom:24px; padding:16px; background:rgba(255,255,255,.03); border-radius:8px; border:1px solid var(--line);">`;
      html += `<h3 style="margin:0 0 12px 0; font-size:15px; font-weight:650;">${slideLabel}</h3>`;
      html += `<div style="display:flex; flex-direction:column; gap:6px;">`;
      
      for (const change of changes.slice().reverse()) {
        const date = new Date(change.timestamp);
        const dateStr = date.toLocaleDateString("pt-BR", { year: "numeric", month: "2-digit", day: "2-digit" });
        const timeStr = date.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        let changeText = "";
        
        if (change.action === "created") {
          changeText = `Criado`;
        } else if (change.field) {
          const fieldLabels = {
            title: "T√≠tulo", p: "P-level", state: "Estado", plan: "Plano",
            difficulty: "Dificuldade", confidence: "Confian√ßa", cogLoad: "Carga cognitiva",
            anchor: "Anchor", objective: "Objective", narrative: "Narrative",
            myNotes: "My Notes", aiNotes: "AI Notes", checked: "Checked", appraisal: "Appraisal"
          };
          const fieldLabel = fieldLabels[change.field] || change.field;
          changeText = `${fieldLabel}: "${escapeHtml(change.oldValue)}" ‚Üí "${escapeHtml(change.newValue)}"`;
        } else {
          changeText = change.action;
        }
        
        html += `<div style="padding:6px 10px; background:rgba(255,255,255,.02); border-radius:4px; font-size:12px; border-left:2px solid var(--fix);">`;
        html += `<span style="color:var(--muted); margin-right:8px; font-size:11px;">${dateStr} ${timeStr}</span>`;
        html += `<span>${changeText}</span>`;
        html += `</div>`;
      }
      html += `</div></div>`;
    }
    body.innerHTML = html;
  };

  // Controles do changelog
  document.querySelectorAll("button[data-changelog-tab]").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("button[data-changelog-tab]").forEach(b => b.classList.toggle("active", b === btn));
      const tab = btn.dataset.changelogTab;
      const dayDiv = document.getElementById("changelog-by-day");
      const slideDiv = document.getElementById("changelog-by-slide");
      if (dayDiv) dayDiv.style.display = tab === "by-day" ? "" : "none";
      if (slideDiv) slideDiv.style.display = tab === "by-slide" ? "" : "none";
      if (tab === "by-day") renderChangelogByDay();
      else renderChangelogBySlide();
    });
  });

  const changelogDeckFilter = document.getElementById("changelogDeckFilter");
  const changelogSlideFilter = document.getElementById("changelogSlideFilter");
  if (changelogDeckFilter) changelogDeckFilter.addEventListener("change", renderChangelogBySlide);
  if (changelogSlideFilter) changelogSlideFilter.addEventListener("input", renderChangelogBySlide);


  // ---------- file sync (optional) ----------
  let fileHandle = null;
  let autoSaveFile = true;
  let pendingWrite = null;

  const supportsFSA = () => !!(window.showOpenFilePicker && window.showSaveFilePicker);
  const setFileStatus = (msg) => { document.getElementById("fileStatus").textContent = msg; };

  // === INDICADOR VISUAL ===
  const updateFileIndicator = (state, text) => {
    const el = document.getElementById('fileIndicator');
    el.className = 'file-indicator ' + state;
    el.textContent = text;
  };

  const writeToLinkedFile = async () => {
    if(!fileHandle) return;
    try{
      updateFileIndicator('saving', 'üíæ Salvando...');
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(DATA, null, 2));
      await writable.close();
      const time = new Date().toLocaleTimeString();
      setFileStatus(`Vinculado: ${fileHandle.name} ‚Ä¢ salvo ${time}`);
      updateFileIndicator('connected', `üü¢ ${fileHandle.name} ‚Ä¢ ${time}`);
    } catch(err){
      console.error(err);
      setFileStatus("Falha ao salvar no arquivo. (Arquivo bloqueado? Permiss√£o?)");
      updateFileIndicator('disconnected', 'Erro ao salvar');
    }
  };

  const scheduleWrite = () => {
    if(!fileHandle || !autoSaveFile) return;
    if(pendingWrite) clearTimeout(pendingWrite);
    pendingWrite = setTimeout(() => { writeToLinkedFile(); pendingWrite = null; }, 700);
  };

  const save = () => {
    localStorage.setItem(LS_KEY, JSON.stringify(DATA));
    scheduleWrite();
  };

  // === ATALHO Ctrl+S ===
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      if (fileHandle) {
        // For√ßa salvamento imediato
        if(pendingWrite) clearTimeout(pendingWrite);
        writeToLinkedFile();
      } else {
        alert('‚ö†Ô∏è Nenhum arquivo vinculado!\n\nV√° em Backup ‚Üí Abrir JSON existente\n\nCaminho sugerido:\nC:\\Users\\lucas\\OneDrive\\LM\\Documentos\\Dev\\SlideOps\\slideops_data.json');
      }
    }
  });

  // ---------- helpers ----------
  const slideKey = (deck, num) => `${deck}#${num}`;
  const findSlide = (key) => DATA.slides.find(s => s.key === key);
  const upsertSlide = (slide) => {
    const idx = DATA.slides.findIndex(s => s.key === slide.key);
    if(idx >= 0) DATA.slides[idx] = slide;
    else DATA.slides.push(slide);
  };

  const escapeHtml = (s) => (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const classifyPChip = (p) => {
    const n = (p||"").toLowerCase();
    return ["p0","p1","p2","p3","p4","p5"].includes(n) ? n : "p3";
  };
  const stateChipClass = (state) => {
    if(state === "Critical") return "state-critical";
    if(state === "Done") return "state-done";
    return "state-fix";
  };
  const planLabel = (plan) => ({Today:"Hoje", Tomorrow:"Amanh√£", ThisWeek:"Semana", Later:"Depois"}[plan] || plan);

  const normalizeTri = (v) => {
    const x = (v||"").toLowerCase();
    if(["low","baixa"].includes(x)) return "Low";
    if(["high","alta"].includes(x)) return "High";
    return "Moderate";
  };
  const confLabel = (v) => ({Low:"Baixa", Moderate:"Moderada", High:"Alta"}[normalizeTri(v)]);
  const cogLabel = (v) => ({Low:"Baixa", Moderate:"Moderada", High:"Alta"}[normalizeTri(v)]);
  const confChipClass = (v) => ({Low:"conf-low", Moderate:"conf-mod", High:"conf-high"}[normalizeTri(v)] || "conf-mod");
  const cogChipClass = (v) => ({Low:"cog-low", Moderate:"cog-mod", High:"cog-high"}[normalizeTri(v)] || "cog-mod");

  // ---------- tabs ----------
  const tabs = Array.from(document.querySelectorAll(".tab[data-tab]"));
  if (tabs.length === 0) {
    console.error("Nenhum bot√£o de aba encontrado!");
  }
  let showTab = (name) => {
    if (!name) {
      console.error("showTab chamado sem nome");
      return;
    }
    for(const t of tabs) {
      if (t) t.classList.toggle("active", t.dataset.tab===name);
    }
    for(const sec of ["backlog","slides","study","changelog","export"]){
      const el = document.getElementById(`tab-${sec}`);
      if (el) {
        el.style.display = (sec===name) ? "" : "none";
      } else {
        console.error(`Elemento tab-${sec} n√£o encontrado!`);
      }
    }
    // Renderizar changelog quando a aba √© aberta
    if (name === "changelog") {
      const activeTab = document.querySelector("button[data-changelog-tab].active");
      if (activeTab && activeTab.dataset.changelogTab === "by-slide") {
        renderChangelogBySlide();
      } else {
        renderChangelogByDay();
      }
    }
  };
  tabs.forEach(btn => {
    if (!btn) return;
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const tabName = btn.dataset.tab;
      if (tabName) {
        showTab(tabName);
      } else {
        console.error("Bot√£o sem data-tab:", btn);
      }
    });
  });

  // ---------- deck subtabs (per aula / per projeto) ----------
  let studyDeckFilter = "GRADE";
  const setDeckSubtab = (scope, deck) => {
    document.querySelectorAll(`button[data-decktab="${scope}"]`).forEach(b => {
      b.classList.toggle("active", b.dataset.deck===deck);
    });
    if(scope==="slides"){
      fDeck.value = deck;
      renderSlides();
    } else if(scope==="study"){
      studyDeckFilter = deck;
      if(deck !== "ALL") document.getElementById("sDeck").value = deck;
      renderStudy();
    }
  };
  document.querySelectorAll('button[data-decktab="slides"]').forEach(b => {
    b.addEventListener("click", () => setDeckSubtab("slides", b.dataset.deck));
  });
  document.querySelectorAll('button[data-decktab="study"]').forEach(b => {
    b.addEventListener("click", () => setDeckSubtab("study", b.dataset.deck));
  });

  // ---------- metrics ----------
  function renderMetrics() {
    const byDeck = (deck) => DATA.slides.filter(s => s.deck===deck);
    const p0Done = (deck) => {
      const all = byDeck(deck).filter(s => s.p==="P0");
      const done = all.filter(s => s.state==="Done");
      return {done: done.length, all: all.length};
    };
    const grade = p0Done("GRADE");
    const osteo = p0Done("OSTEO");
    document.getElementById("mGradeP0").textContent = `${grade.done}/${grade.all}`;
    document.getElementById("mOsteoP0").textContent = `${osteo.done}/${osteo.all}`;
    document.getElementById("mGradeHint").textContent = grade.all ? `Faltam ${Math.max(0,grade.all-grade.done)} P0` : "Defina P0 (marque slides P0)";
    document.getElementById("mOsteoHint").textContent = osteo.all ? `Faltam ${Math.max(0,osteo.all-osteo.done)} P0` : "Defina P0 (marque slides P0)";
    const critical = DATA.slides.filter(s => s.state==="Critical").length;
    document.getElementById("mCritical").textContent = critical;
    const checked = DATA.slides.filter(s => s.checked==="Yes").length;
    const appraisal = DATA.slides.filter(s => s.appraisal==="Yes").length;
    const total = DATA.slides.length || 1;
    document.getElementById("mQA").textContent = `${Math.round(100*checked/total)}% / ${Math.round(100*appraisal/total)}%`;
  }

  // ---------- priority ----------
  const priorityScore = (s) => {
    const pRank = {P0:0,P1:1,P2:2,P3:3,P4:4,P5:5}[s.p] ?? 9;
    const stateRank = {Critical:0, NeedsFix:1, Done:2}[s.state] ?? 1;
    const planRank = {Today:0, Tomorrow:1, ThisWeek:2, Later:3}[s.plan] ?? 2;
    const diff = parseInt(s.difficulty||3,10) || 3;
    const modRank = s.lastModified ? -new Date(s.lastModified).getTime() : 0;
    // Lower is "more urgent": plan first, then P, then state, then difficulty (harder first inside bucket), then recency
    return planRank*1000 + pRank*100 + stateRank*10 - diff + (modRank/1e15);
  };

  // ---------- slides render ----------
  const slidesBody = document.getElementById("slidesBody");
  const fDeck = document.getElementById("fDeck");
  const fSort = document.getElementById("fSort");
  if (!fSort) console.error("Elemento fSort n√£o encontrado no DOM!");
  function renderSlides() {
    const deck = fDeck ? fDeck.value : "ALL";

    let list = DATA.slides.slice();
    if(deck !== "ALL") list = list.filter(s => s.deck === deck);

    const sortValue = fSort ? fSort.value : "priority";
    if(sortValue === "modified") {
      list.sort((a,b) => (new Date(b.lastModified||0)) - (new Date(a.lastModified||0)));
    } else if(sortValue === "plan") {
      // Ordena√ß√£o por plano (Today, Tomorrow, ThisWeek, Later)
      const planOrder = {Today: 0, Tomorrow: 1, ThisWeek: 2, Later: 3};
      const planRank = (s) => planOrder[s.plan] ?? 2;
      list.sort((a,b) => {
        const d = planRank(a) - planRank(b);
        if(d !== 0) return d;
        // Se mesmo plano, ordenar por prioridade
        return priorityScore(a) - priorityScore(b);
      });
    } else if(sortValue === "slide") {
      // Ordena√ß√£o num√©rica: primeiro por deck, depois por n√∫mero (num√©rico, n√£o string)
      list.sort((a,b) => {
        const deckCmp = String(a.deck).localeCompare(String(b.deck));
        if(deckCmp !== 0) return deckCmp;
        return a.num - b.num; // Ordena√ß√£o num√©rica correta
      });
    } else if(sortValue === "state") {
      const stateOrder = {Critical:0, NeedsFix:1, Done:2};
      const stateRank = (s) => stateOrder[s.state] ?? 1;
      list.sort((a,b) => {
        const d = stateRank(a) - stateRank(b);
        if(d !== 0) return d;
        // Ordena√ß√£o num√©rica secund√°ria
        const deckCmp = String(a.deck).localeCompare(String(b.deck));
        if(deckCmp !== 0) return deckCmp;
        return a.num - b.num; // Ordena√ß√£o num√©rica correta
      });
    } else {
      list.sort((a,b) => priorityScore(a) - priorityScore(b));
    }

    slidesBody.innerHTML = "";
    for(const s of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.deck}</td>
        <td>${s.num}</td>
        <td>${escapeHtml(s.title||"")}</td>
        <td><span class="chip ${classifyPChip(s.p)}">${s.p}</span></td>
        <td><span class="chip ${stateChipClass(s.state)}">${s.state}</span></td>
        <td>${planLabel(s.plan)}</td>
        <td>${s.difficulty ?? 3}</td>
        <td><span class="chip ${confChipClass(s.confidence)}">${confLabel(s.confidence)}</span></td>
        <td><span class="chip ${cogChipClass(s.cogLoad)}">${cogLabel(s.cogLoad)}</span></td>
        <td>${fmt(s.lastModified)}</td>
        <td>${s.checked==="Yes" ? "‚úÖ" : "‚Äî"}</td>
        <td>${s.appraisal==="Yes" ? "‚úÖ" : "‚Äî"}</td>
        <td><button class="ghost" data-edit="${s.key}">Editar</button></td>
      `;
      slidesBody.appendChild(tr);
    }

    slidesBody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => openEditor(btn.dataset.edit));
    });
  }

  // ---------- backlog board ----------
  const bDeck = document.getElementById("bDeck");
  const bShowDone = document.getElementById("bShowDone");
  const cols = ["Today","Tomorrow","ThisWeek","Later"];
  const colEls = {
    Today: document.getElementById("col-Today"),
    Tomorrow: document.getElementById("col-Tomorrow"),
    ThisWeek: document.getElementById("col-ThisWeek"),
    Later: document.getElementById("col-Later"),
  };

  let draggingKey = null;

  const makeCard = (s) => {
    const div = document.createElement("div");
    div.className = "cardItem";
    div.draggable = true;
    div.dataset.key = s.key;
    div.innerHTML = `
      <div class="minirow">
        <span class="chip ${classifyPChip(s.p)}">${s.p}</span>
        <span class="chip ${stateChipClass(s.state)}">${s.state}</span>
        <span class="chip">Dif ${s.difficulty ?? 3}</span>
        <span class="chip ${confChipClass(s.confidence)}">Conf ${confLabel(s.confidence)}</span>
        <span class="chip ${cogChipClass(s.cogLoad)}">Cog ${cogLabel(s.cogLoad)}</span>
      </div>
      <div style="margin-top:6px; font-weight:650">${escapeHtml(s.deck)} #${s.num}</div>
      <div class="small" style="margin-top:2px">${escapeHtml(s.title||"") || "<em>(sem t√≠tulo)</em>"}</div>
      ${s.anchor ? `<div class="small" style="margin-top:6px">EBM: ${escapeHtml(s.anchor)}</div>` : ""}
    `;
    div.addEventListener("click", () => openEditor(s.key, true));
    div.addEventListener("dragstart", (e) => {
      draggingKey = s.key;
      div.classList.add("dragging");
      e.dataTransfer.setData("text/plain", s.key);
      e.dataTransfer.effectAllowed = "move";
    });
    div.addEventListener("dragend", () => {
      draggingKey = null;
      div.classList.remove("dragging");
      document.querySelectorAll(".colBody").forEach(el => el.classList.remove("dropHint"));
    });
    return div;
  };

  function renderBacklog() {
    const deckFilter = bDeck.value;
    const showDone = bShowDone.value === "Yes";

    let list = DATA.slides.slice();
    if(deckFilter !== "ALL") list = list.filter(s => s.deck === deckFilter);
    if(!showDone) list = list.filter(s => s.state !== "Done");

    // ensure plan
    for(const s of list){ if(!s.plan) s.plan = "ThisWeek"; }

    // clear columns
    for(const c of cols) colEls[c].innerHTML = "";

    // sort inside column by P/state/diff/mod
    list.sort((a,b) => priorityScore(a) - priorityScore(b));

    const counts = {Today:0, Tomorrow:0, ThisWeek:0, Later:0};
    for(const s of list){
      const p = cols.includes(s.plan) ? s.plan : "ThisWeek";
      counts[p] += 1;
      colEls[p].appendChild(makeCard(s));
    }

    document.getElementById("cToday").textContent = `${counts.Today}`;
    document.getElementById("cTomorrow").textContent = `${counts.Tomorrow}`;
    document.getElementById("cThisWeek").textContent = `${counts.ThisWeek}`;
    document.getElementById("cLater").textContent = `${counts.Later}`;
  }

  // drop zones
  document.querySelectorAll(".colBody").forEach(body => {
    body.addEventListener("dragover", (e) => {
      e.preventDefault();
      body.classList.add("dropHint");
      e.dataTransfer.dropEffect = "move";
    });
    body.addEventListener("dragleave", () => body.classList.remove("dropHint"));
    body.addEventListener("drop", (e) => {
      e.preventDefault();
      body.classList.remove("dropHint");
      const key = e.dataTransfer.getData("text/plain") || draggingKey;
      if(!key) return;
      const s = findSlide(key);
      if(!s) return;
      const plan = body.id.replace("col-","");
      s.plan = plan;
      s.lastModified = nowISO();
      upsertSlide(s);
      save();
      renderAll();
    });
  });

  bDeck.addEventListener("change", renderBacklog);
  bShowDone.addEventListener("change", renderBacklog);

  // ---------- editor ----------
  const eKey = document.getElementById("eKey");
  const eTitle = document.getElementById("eTitle");
  const eP = document.getElementById("eP");
  const ePlan = document.getElementById("ePlan");
  const eDiff = document.getElementById("eDiff");
  const eChecked = document.getElementById("eChecked");
  const eAppraisal = document.getElementById("eAppraisal");
  const eConfLow = document.getElementById("eConfLow");
  const eConfMod = document.getElementById("eConfMod");
  const eConfHigh = document.getElementById("eConfHigh");
  const eCogLow = document.getElementById("eCogLow");
  const eCogMod = document.getElementById("eCogMod");
  const eCogHigh = document.getElementById("eCogHigh");
  const eAnchor = document.getElementById("eAnchor");
  const htmlCommentsBox = document.getElementById("htmlCommentsBox");
  const eObjective = document.getElementById("eObjective");
  const eNarrative = document.getElementById("eNarrative");
  const eMyNotes = document.getElementById("eMyNotes");
  const eAiNotes = document.getElementById("eAiNotes");
  const btnSave = document.getElementById("btnSave");
  const btnCancel = document.getElementById("btnCancel");
  const saveStatus = document.getElementById("saveStatus");
  const btnCopyBrief = document.getElementById("btnCopyBrief");
  const briefHint = document.getElementById("briefHint");

  let pendingConfidence = "Moderate";
  let pendingCog = "Moderate";

  const setPillActive = (group, value) => {
    for(const [val, btn] of Object.entries(group)){
      if(!btn) continue;
      btn.classList.toggle("active", val===value);
    }
  };

  const CONF_BTNS = {Low: eConfLow, Moderate: eConfMod, High: eConfHigh};
  const COG_BTNS = {Low: eCogLow, Moderate: eCogMod, High: eCogHigh};

  const enableEditor = (on) => {
    btnSave.disabled = !on;
    btnCancel.disabled = !on;
    btnCopyBrief.disabled = !on;
  };

  const clearEditor = () => {
    selectedKey = null;
    eKey.value = "";
    eTitle.value = "";
    eP.value = "P1";
    ePlan.value = "ThisWeek";
    eDiff.value = "3";
    eChecked.value = "No";
    eAppraisal.value = "No";
    eAnchor.value = "";
    if (htmlCommentsBox) {
      htmlCommentsBox.textContent = 'Nenhum coment√°rio encontrado no HTML';
      htmlCommentsBox.style.color = 'rgba(255,255,255,.5)';
      htmlCommentsBox.style.fontStyle = 'italic';
    }
    eObjective.value = "";
    eNarrative.value = "";
    eMyNotes.value = "";
    eAiNotes.value = "";
    pendingConfidence = "Moderate";
    pendingCog = "Moderate";
    setPillActive(CONF_BTNS, pendingConfidence);
    setPillActive(COG_BTNS, pendingCog);
    saveStatus.textContent = "‚Äî";
    briefHint.textContent = "‚Äî";
    enableEditor(false);
  };

  const openEditor = (key, fromBacklog=false) => {
    const s = findSlide(key);
    if(!s) return;
    selectedKey = key;
    eKey.value = s.key;
    eTitle.value = s.title || "";
    eP.value = s.p || "P1";
    ePlan.value = s.plan || "ThisWeek";
    eDiff.value = String(s.difficulty ?? 3);
    eChecked.value = s.checked || "No";
    eAppraisal.value = s.appraisal || "No";
    pendingConfidence = s.confidence || "Moderate";
    pendingCog = s.cogLoad || "Moderate";
    setPillActive(CONF_BTNS, pendingConfidence);
    setPillActive(COG_BTNS, pendingCog);
    eAnchor.value = s.anchor || "";
    // Atualizar caixa de coment√°rios do HTML
    if (htmlCommentsBox) {
      const htmlData = [];
      if (s.title) htmlData.push(`üìå T√≠tulo: ${s.title}`);
      if (s.anchor) htmlData.push(`üîó Anchor: ${s.anchor}`);
      if (s.htmlComments) htmlData.push(`üí° Coment√°rios/Boas pr√°ticas:\n${s.htmlComments}`);
      htmlCommentsBox.textContent = htmlData.length > 0 ? htmlData.join('\n\n') : 'Nenhum coment√°rio encontrado no HTML';
      htmlCommentsBox.style.color = htmlData.length > 0 ? 'rgba(255,255,255,.85)' : 'rgba(255,255,255,.5)';
      htmlCommentsBox.style.fontStyle = htmlData.length > 0 ? 'normal' : 'italic';
    }
    eObjective.value = s.objective || "";
    eNarrative.value = s.narrative || "";
    eMyNotes.value = s.myNotes || "";
    eAiNotes.value = s.aiNotes || "";
    saveStatus.textContent = `Editando ${s.deck} #${s.num}`;
    briefHint.textContent = "Use para pedir √† AI: texto do slide + 1 n√∫mero + refer√™ncia.";
    enableEditor(true);
    if(fromBacklog) showTab("slides");
  };

  // state buttons: autoSave primeiro (titulo etc), depois estado ‚Üí save ‚Üí render ‚Üí reabre editor
  const setState = (state) => {
    if(!selectedKey) return;
    autoSave();
    const s = findSlide(selectedKey);
    if(!s) return;
    const oldState = s.state || "";
    if (oldState !== state) {
      logChange(selectedKey, "state", oldState, state);
    }
    s.state = state;
    s.lastModified = nowISO();
    upsertSlide(s);
    save();
    renderMetrics();
    renderSlides();
    openEditor(selectedKey);
    saveStatus.textContent = `Estado ‚Üí ${state} ‚úî`;
  };
  document.getElementById("eCritical").addEventListener("click", (e) => { e.preventDefault(); setState("Critical"); });
  document.getElementById("eNeedsFix").addEventListener("click", (e) => { e.preventDefault(); setState("NeedsFix"); });
  document.getElementById("eDone").addEventListener("click", (e) => { e.preventDefault(); setState("Done"); });

  // AUTO-SAVE: salva o slide atual com todos os valores do formul√°rio
  const autoSave = () => {
    if(!selectedKey) return;
    const s = findSlide(selectedKey);
    if(!s) return;
    
    // Registrar mudan√ßas antes de atualizar
    const fields = [
      { name: "title", old: s.title || "", new: eTitle.value.trim() },
      { name: "p", old: s.p || "", new: eP.value },
      { name: "plan", old: s.plan || "", new: ePlan.value },
      { name: "difficulty", old: String(s.difficulty ?? 3), new: String(parseInt(eDiff.value,10) || 3) },
      { name: "checked", old: s.checked || "", new: eChecked.value },
      { name: "appraisal", old: s.appraisal || "", new: eAppraisal.value },
      { name: "confidence", old: s.confidence || "", new: pendingConfidence },
      { name: "cogLoad", old: s.cogLoad || "", new: pendingCog },
      { name: "anchor", old: s.anchor || "", new: eAnchor.value.trim() },
      { name: "objective", old: s.objective || "", new: eObjective.value.trim() },
      { name: "narrative", old: s.narrative || "", new: eNarrative.value.trim() },
      { name: "myNotes", old: s.myNotes || "", new: eMyNotes.value },
      { name: "aiNotes", old: s.aiNotes || "", new: eAiNotes.value }
    ];
    
    for (const field of fields) {
      if (field.old !== field.new) {
        logChange(selectedKey, field.name, field.old, field.new);
      }
    }
    
    // Atualizar slide
    s.title = eTitle.value.trim();
    s.p = eP.value;
    s.plan = ePlan.value;
    s.difficulty = parseInt(eDiff.value,10) || 3;
    s.checked = eChecked.value;
    s.appraisal = eAppraisal.value;
    s.confidence = pendingConfidence;
    s.cogLoad = pendingCog;
    s.anchor = eAnchor.value.trim();
    s.objective = eObjective.value.trim();
    s.narrative = eNarrative.value.trim();
    s.myNotes = eMyNotes.value;
    s.aiNotes = eAiNotes.value;
    s.lastModified = nowISO();
    upsertSlide(s);
    save();
    // Atualiza m√©tricas e tabela de slides
    renderMetrics();
    renderSlides();
    // Mant√©m editor aberto no mesmo slide
    saveStatus.textContent = "Auto-salvo ‚úî";
  };

  // Debounce para campos de texto (espera 500ms ap√≥s parar de digitar)
  let debounceTimer = null;
  const autoSaveDebounced = () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(autoSave, 500);
  };
  const flushAndSave = () => {
    clearTimeout(debounceTimer);
    debounceTimer = null;
    autoSave();
  };

  const setConfidence = (val) => {
    pendingConfidence = val;
    setPillActive(CONF_BTNS, val);
    autoSave();
    save();
    renderSlides();
  };
  const setCog = (val) => {
    pendingCog = val;
    setPillActive(COG_BTNS, val);
    autoSave();
    save();
    renderSlides();
  };
  eConfLow.addEventListener("click", () => setConfidence("Low"));
  eConfMod.addEventListener("click", () => setConfidence("Moderate"));
  eConfHigh.addEventListener("click", () => setConfidence("High"));
  eCogLow.addEventListener("click", () => setCog("Low"));
  eCogMod.addEventListener("click", () => setCog("Moderate"));
  eCogHigh.addEventListener("click", () => setCog("High"));

  // AUTO-SAVE em selects (change = imediato) ‚Üí atualiza linha na tabela
  eP.addEventListener("change", () => { autoSave(); renderSlides(); });
  ePlan.addEventListener("change", () => { autoSave(); renderSlides(); });
  eDiff.addEventListener("change", () => { autoSave(); renderSlides(); });
  eChecked.addEventListener("change", () => { autoSave(); renderSlides(); });
  eAppraisal.addEventListener("change", () => { autoSave(); renderSlides(); });

  // AUTO-SAVE em inputs de texto: debounce ao digitar + flush imediato ao sair (blur)
  const textInputs = [eTitle, eAnchor, eObjective, eNarrative, eMyNotes, eAiNotes];
  textInputs.forEach(el => {
    el.addEventListener("input", autoSaveDebounced);
    el.addEventListener("blur", flushAndSave);
  });

  // save slide edits (bot√£o manual - backup do auto-save)
  btnSave.addEventListener("click", () => {
    autoSave();
    save();
    renderSlides();
    saveStatus.textContent = "Salvo manualmente ‚úî";
  });

  btnCancel.addEventListener("click", () => {
    if(!selectedKey) return;
    openEditor(selectedKey);
    saveStatus.textContent = "Revertido (sem salvar)";
  });

  // copy brief for AI
  btnCopyBrief.addEventListener("click", async () => {
    if(!selectedKey) return;
    const s = findSlide(selectedKey);
    if(!s) return;
    const txt = `Slide: ${s.deck} #${s.num}
T√≠tulo: ${s.title || "(sem t√≠tulo)"}
P-level: ${s.p} | Estado: ${s.state} | Plano: ${s.plan} | Dificuldade: ${s.difficulty ?? 3}
Confian√ßa: ${confLabel(s.confidence)} | Carga cognitiva: ${cogLabel(s.cogLoad)}

√Çncora EBM (se existir):
${s.anchor || "‚Äî"}

Objetivo:
${s.objective || "‚Äî"}

Narrativa & intera√ß√£o:
${s.narrative || "‚Äî"}

Tarefa para a AI:
- Proponha o texto do slide (m√°x. 1‚Äì2 linhas grandes)
- Inclua 1 n√∫mero absoluto quando poss√≠vel (ARR/NNT/NNH)
- Sugira 1 refer√™ncia curta (autor/ano ou guideline)
- Sugira 1 frase de nota de fala (speaker note)
- Se a carga cognitiva estiver alta: proponha vers√£o simplificada ou divis√£o em 2 slides
`;
    try{
      await navigator.clipboard.writeText(txt);
      briefHint.textContent = "Brief copiado ‚úî (cole na conversa com a AI)";
    }catch{
      briefHint.textContent = "N√£o consegui copiar automaticamente. Selecione e copie manualmente.";
      alert(txt);
    }
  });

  // AI template insert
  document.getElementById("btnInsertAiTpl").addEventListener("click", () => {
    const tpl = `[Claim]
- ...

[Evidence]
- Fonte (autor/ano/PMID/DOI/guideline)

[Effect size]
- Absoluto (ARR/NNT/NNH) se poss√≠vel
- Relativo (RR/HR) se relevante

[Certainty]
- GRADE: alta/moderada/baixa + motivo dominante

[Applicability]
- Popula√ß√£o / cen√°rio / trade-offs

[Suggested slide line]
- Mensagem + n√∫mero + refer√™ncia (1 linha)`;
    if(eAiNotes.value.trim().length === 0) eAiNotes.value = tpl;
    else eAiNotes.value = eAiNotes.value.trim() + "\n\n" + tpl;
  });

  // ---------- reordena√ß√£o e sincroniza√ß√£o ----------
  const getDeckSlides = (deck) => {
    return DATA.slides.filter(s => s.deck === deck).sort((a,b) => a.num - b.num);
  };

  const renumerateDeck = (deck) => {
    const slides = getDeckSlides(deck);
    slides.forEach((s, idx) => {
      const newNum = idx + 1; // Sempre come√ßa em 1 (capa)
      s.num = newNum;
      s.key = `${deck}#${newNum}`;
      s.lastModified = nowISO();
      upsertSlide(s);
    });
  };

  // ---------- extract metadata from HTML comments ----------
  const extractSlideMetadata = async (slideFile, deck) => {
    // Tentar m√∫ltiplos caminhos
    const pathCandidates = deck === "GRADE" 
      ? [
          `/GRADE/src/slides/${slideFile}`,
          `../GRADE/src/slides/${slideFile}`,
          `../../GRADE/src/slides/${slideFile}`
        ]
      : [
          `/OSTEOPOROSE/src/slides/${slideFile}`,
          `../OSTEOPOROSE/src/slides/${slideFile}`,
          `../../OSTEOPOROSE/src/slides/${slideFile}`
        ];
    
    for (const path of pathCandidates) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (res.ok) {
          const html = await res.text();
          
          const metadata = {};
          
          // Procurar coment√°rios no formato: <!-- SlideOps: title="..." anchor="..." aiTips="..." -->
          const slideOpsComment = html.match(/<!--\s*SlideOps:\s*([^>]+)-->/i);
          if (slideOpsComment) {
            const attrs = slideOpsComment[1];
            // Extrair apenas: title, anchor, aiTips
            const attrRegex = /(\w+)="([^"]*)"/g;
            let match;
            while ((match = attrRegex.exec(attrs)) !== null) {
              const key = match[1].toLowerCase();
              if (key === "title" || key === "anchor" || key === "aitips") {
                metadata[key] = match[2];
              }
            }
          }
          
          // Fallback: procurar coment√°rios individuais <!-- title: ... -->, <!-- anchor: ... -->, <!-- aiTips: ... -->
          const singleCommentRegex = /<!--\s*(\w+):\s*([^->]+)-->/g;
          let match;
          while ((match = singleCommentRegex.exec(html)) !== null) {
            const key = match[1].toLowerCase();
            const value = match[2].trim();
            if (key === "title") metadata.title = value;
            else if (key === "anchor") metadata.anchor = value;
            else if (key === "aitips" || key === "aitip" || key === "tips" || key === "comments") metadata.aiTips = value;
          }
          
          if (Object.keys(metadata).length > 0) {
            return metadata;
          }
        }
      } catch (e) {
        // Continuar tentando outros caminhos
      }
    }
    return null;
  };

  // ---------- import from _list.txt ----------
  document.getElementById("btnImportFromDeck").addEventListener("click", async () => {
    const deck = document.getElementById("genDeck").value;
    const deckName = deck === "GRADE" ? "GRADE" : "OSTEOPOROSE";
    
    const pathCandidates = deck === "GRADE" 
      ? ["/GRADE/src/slides/_list.txt", "../GRADE/src/slides/_list.txt", "../../GRADE/src/slides/_list.txt"]
      : ["/OSTEOPOROSE/src/slides/_list.txt", "../OSTEOPOROSE/src/slides/_list.txt", "../../OSTEOPOROSE/src/slides/_list.txt"];
    
    saveStatus.textContent = "Importando...";
    
    try {
      let res = null;
      for (const path of pathCandidates) {
        try {
          res = await fetch(path, { cache: 'no-store' });
          if (res.ok) break;
        } catch (e) {}
      }
      
      if (!res || !res.ok) {
        throw new Error(`N√£o foi poss√≠vel ler _list.txt. Tentou: ${pathCandidates.join(', ')}`);
      }
      
      const text = await res.text();
      const lines = text.split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean)
        .filter(l => !l.startsWith('#'));
      
      if (lines.length === 0) {
        alert(`_list.txt est√° vazio para ${deckName}`);
        saveStatus.textContent = "Nenhum slide encontrado";
        return;
      }
      
      let created = 0;
      let skipped = 0;
      let withMetadata = 0;
      
      // IMPORTANTE: num come√ßa em 1 (capa √© slide 1)
      for (let i = 0; i < lines.length; i++) {
        const num = i + 1; // Posi√ß√£o 0 = slide 1 (capa), posi√ß√£o 1 = slide 2, etc.
        const key = slideKey(deck, num);
        const existing = findSlide(key);
        if (existing) {
          skipped++;
          continue;
        }
        
        // Tentar extrair metadados do ficheiro HTML
        const slideFile = lines[i].includes('.html') ? lines[i] : `${lines[i]}.html`;
        const metadata = await extractSlideMetadata(slideFile, deck);
        
        const newSlide = {
          key, deck, num,
          title: metadata?.title || "",
          p: "P1", // Padr√£o - n√£o vem do HTML
          state: "NeedsFix", // Padr√£o - n√£o vem do HTML
          plan: "ThisWeek", // Padr√£o - n√£o vem do HTML
          difficulty: 3, // Padr√£o - n√£o vem do HTML
          confidence: "Moderate",
          cogLoad: "Moderate",
          anchor: metadata?.anchor || "",
          htmlComments: metadata?.aiTips || "", // Coment√°rios/boas pr√°ticas do HTML
          checked: "No",
          appraisal: "No",
          objective: "",
          narrative: "",
          myNotes: "",
          aiNotes: "",
          lastModified: nowISO()
        };
        
        if (metadata) withMetadata++;
        DATA.slides.push(newSlide);
        logChange(key, null, "", "", "created");
        created++;
      }
      
      save();
      renderAll();
      saveStatus.textContent = `Importados ${created} slides de ${deckName}${skipped > 0 ? ` (${skipped} j√° existiam)` : ''}${withMetadata > 0 ? `, ${withMetadata} com metadados dos coment√°rios` : ''} ‚úî`;
    } catch (err) {
      console.error(err);
      alert(`Erro ao importar: ${err.message}\n\nCertifique-se de que o SlideOps est√° sendo servido por um servidor HTTP (n√£o file://)`);
      saveStatus.textContent = "Erro ao importar";
    }
  });

  // ---------- sync numbers from _list.txt (preserves metadata, updates from HTML comments) ----------
  document.getElementById("btnSyncNumbers").addEventListener("click", async () => {
    const deck = document.getElementById("genDeck").value;
    const deckName = deck === "GRADE" ? "GRADE" : "OSTEOPOROSE";
    
    const pathCandidates = deck === "GRADE" 
      ? ["/GRADE/src/slides/_list.txt", "../GRADE/src/slides/_list.txt", "../../GRADE/src/slides/_list.txt"]
      : ["/OSTEOPOROSE/src/slides/_list.txt", "../OSTEOPOROSE/src/slides/_list.txt", "../../OSTEOPOROSE/src/slides/_list.txt"];
    
    saveStatus.textContent = "Sincronizando n√∫meros e metadados...";
    
    try {
      let res = null;
      for (const path of pathCandidates) {
        try {
          res = await fetch(path, { cache: 'no-store' });
          if (res.ok) break;
        } catch (e) {}
      }
      
      if (!res || !res.ok) {
        throw new Error(`N√£o foi poss√≠vel ler _list.txt. Tentou: ${pathCandidates.join(', ')}`);
      }
      
      const text = await res.text();
      const lines = text.split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean)
        .filter(l => !l.startsWith('#'));
      
      if (lines.length === 0) {
        alert(`_list.txt est√° vazio para ${deckName}`);
        saveStatus.textContent = "Nenhum slide encontrado";
        return;
      }
      
      const existingSlides = DATA.slides.filter(s => s.deck === deck).sort((a, b) => a.num - b.num);
      if (existingSlides.length === 0) {
        alert(`Nenhum slide encontrado no SlideOps para ${deckName}. Use "Importar slides" primeiro.`);
        saveStatus.textContent = "Nenhum slide para sincronizar";
        return;
      }
      
      let updatedMetadata = 0;
      
      // Para cada linha do _list.txt, atualizar slide correspondente
      // Assumir que a ordem atual dos slides (por num) corresponde √† ordem do _list.txt
      for (let i = 0; i < Math.min(lines.length, existingSlides.length); i++) {
        const newNum = i + 1;
        const oldSlide = existingSlides[i];
        if (!oldSlide) continue;
        
        // Tentar ler metadados do ficheiro HTML
        const slideFile = lines[i].includes('.html') ? lines[i] : `${lines[i]}.html`;
        const metadata = await extractSlideMetadata(slideFile, deck);
        
        if (metadata) {
          // Atualizar apenas metadados que v√™m do HTML: title, anchor, htmlComments (aiTips)
          if (metadata.title && metadata.title.trim() && metadata.title !== oldSlide.title) {
            const oldTitle = oldSlide.title || "";
            oldSlide.title = metadata.title.trim();
            logChange(oldSlide.key, "title", oldTitle, metadata.title.trim());
            updatedMetadata++;
          }
          if (metadata.anchor !== undefined && metadata.anchor.trim() && metadata.anchor.trim() !== oldSlide.anchor) {
            const oldAnchor = oldSlide.anchor || "";
            oldSlide.anchor = metadata.anchor.trim();
            logChange(oldSlide.key, "anchor", oldAnchor, metadata.anchor.trim());
            updatedMetadata++;
          }
          if (metadata.aiTips !== undefined && metadata.aiTips.trim() && metadata.aiTips.trim() !== (oldSlide.htmlComments || "")) {
            const oldComments = oldSlide.htmlComments || "";
            oldSlide.htmlComments = metadata.aiTips.trim();
            logChange(oldSlide.key, "htmlComments", oldComments, metadata.aiTips.trim());
            updatedMetadata++;
          }
        }
        
        // Atualizar n√∫mero se necess√°rio
        if (oldSlide.num !== newNum) {
          const oldKey = oldSlide.key;
          oldSlide.num = newNum;
          oldSlide.key = slideKey(deck, newNum);
          oldSlide.lastModified = nowISO();
          
          // Atualizar no array
          const idx = DATA.slides.findIndex(s => s.key === oldKey);
          if (idx >= 0) {
            DATA.slides[idx] = oldSlide;
          }
        } else {
          oldSlide.lastModified = nowISO();
        }
      }
      
      // Garantir que todos os slides est√£o sequenciais (caso haja mais slides do que linhas)
      renumerateDeck(deck);
      
      const updated = existingSlides.length;
      save();
      renderAll();
      saveStatus.textContent = `Sincronizados ${updated} slides de ${deckName}${updatedMetadata > 0 ? `, ${updatedMetadata} com metadados atualizados` : ''} ‚úî`;
    } catch (err) {
      console.error(err);
      alert(`Erro ao sincronizar: ${err.message}\n\nCertifique-se de que o SlideOps est√° sendo servido por um servidor HTTP (n√£o file://)`);
      saveStatus.textContent = "Erro ao sincronizar";
    }
  });

  // ---------- generate skeleton ----------
  document.getElementById("btnGenerate").addEventListener("click", () => {
    const deck = document.getElementById("genDeck").value;
    const range = document.getElementById("genRange").value.trim();
    
    // Aceita: "3" (√∫nico) ou "1-35" (intervalo)
    const m = range.match(/^(\d+)(?:\s*-\s*(\d+))?$/);
    if(!m){
      alert("Use: n√∫mero √∫nico (ex: 3) ou intervalo (ex: 1-35)");
      return;
    }
    let a = parseInt(m[1],10);
    let b = m[2] ? parseInt(m[2],10) : a;  // Se n√£o tem segundo n√∫mero, b = a
    if(b < a) [a,b] = [b,a];

    for(let n=a; n<=b; n++){
      const key = slideKey(deck, n);
      const existing = findSlide(key);
      if(existing) continue;
      const newSlide = {
        key, deck, num:n,
        title:"",
        p:"P1",
        state:"NeedsFix",
        plan:"ThisWeek",
        difficulty:3,
        confidence:"Moderate",
        cogLoad:"Moderate",
        anchor:"",
        checked:"No",
        appraisal:"No",
        objective:"",
        narrative:"",
        myNotes:"",
        aiNotes:"",
        lastModified: nowISO()
      };
      DATA.slides.push(newSlide);
      logChange(key, null, "", "", "created");
    }
    save(); clearEditor(); renderAll();
  });

  document.getElementById("btnClearAll").addEventListener("click", () => {
    if(!confirm("Isso apaga tudo (slides e estudos). Tem certeza?")) return;
    DATA = structuredClone(DEFAULT);
    save(); clearEditor(); renderAll();
  });

  // filters
  if (fDeck) {
    fDeck.addEventListener("change", () => {
      console.log("Deck mudou para:", fDeck.value);
      renderSlides();
    });
  }
  if (fSort) {
    fSort.addEventListener("change", () => {
      console.log("Sort mudou para:", fSort.value);
      renderSlides();
    });
  } else {
    console.error("fSort n√£o encontrado! Elemento:", document.getElementById("fSort"));
  }

  // ---------- study ----------
  const studyBody = document.getElementById("studyBody");
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

  function renderStudy() {
    studyBody.innerHTML = "";
    let list = DATA.studies.slice();
    if(studyDeckFilter !== "ALL") list = list.filter(it => it.deck === studyDeckFilter);
    list = list.sort((a,b) => (new Date(b.lastModified||0))-(new Date(a.lastModified||0)));
    for(const it of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.deck}</td>
        <td>${escapeHtml(it.range||"")}</td>
        <td>${escapeHtml(it.material||"")}</td>
        <td><span class="chip">${it.status}</span></td>
        <td>${it.cards ?? 0}</td>
        <td>${fmt(it.lastModified)}</td>
        <td><button class="ghost" data-edit="${it.id}">Editar</button></td>
      `;
      studyBody.appendChild(tr);
    }
    studyBody.querySelectorAll("button[data-edit]").forEach(btn => btn.addEventListener("click", () => openStudy(btn.dataset.edit)));
  }

  document.getElementById("btnAddStudy").addEventListener("click", () => {
    const deck = document.getElementById("sDeck").value;
    const range = document.getElementById("sRange").value.trim();
    const material = document.getElementById("sMaterial").value.trim();
    const status = document.getElementById("sStatus").value;
    const cards = parseInt(document.getElementById("sCards").value,10) || 0;
    const notes = document.getElementById("sNotes").value;
    if(!range && !material){ alert("Preencha ao menos alvo ou material."); return; }
    DATA.studies.push({ id: uid(), deck, range, material, status, cards, notes, lastModified: nowISO() });
    save(); renderAll();
    document.getElementById("sRange").value = "";
    document.getElementById("sMaterial").value = "";
    document.getElementById("sNotes").value = "";
    document.getElementById("sCards").value = 0;
  });

  document.getElementById("btnClearStudy").addEventListener("click", () => {
    if(!confirm("Zerar estudos?")) return;
    DATA.studies = [];
    save(); renderAll();
  });

  // ---------- render all (usar function declaration para hoisting) ----------
  function renderAll() {
    renderMetrics();
    renderBacklog();
    renderSlides();
    renderStudy();
  }

  // study editor
  const seId = document.getElementById("seId");
  const seStatus = document.getElementById("seStatus");
  const seCards = document.getElementById("seCards");
  const seNotes = document.getElementById("seNotes");
  const seMaterial = document.getElementById("seMaterial");
  const seRange = document.getElementById("seRange");
  const btnSaveStudy = document.getElementById("btnSaveStudy");
  const btnDeleteStudy = document.getElementById("btnDeleteStudy");
  const studyStatus = document.getElementById("studyStatus");
  let selectedStudy = null;

  const openStudy = (id) => {
    const it = DATA.studies.find(x => x.id===id);
    if(!it) return;
    selectedStudy = id;
    seId.value = it.id;
    seStatus.value = it.status;
    seCards.value = it.cards ?? 0;
    seNotes.value = it.notes || "";
    seMaterial.value = it.material || "";
    seRange.value = it.range || "";
    btnSaveStudy.disabled = false;
    btnDeleteStudy.disabled = false;
    studyStatus.textContent = "Editando...";
  };

  btnSaveStudy.addEventListener("click", () => {
    if(!selectedStudy) return;
    const it = DATA.studies.find(x => x.id===selectedStudy);
    if(!it) return;
    it.status = seStatus.value;
    it.cards = parseInt(seCards.value,10) || 0;
    it.notes = seNotes.value;
    it.material = seMaterial.value.trim();
    it.range = seRange.value.trim();
    it.lastModified = nowISO();
    save(); renderAll();
    studyStatus.textContent = "Salvo ‚úî";
  });

  btnDeleteStudy.addEventListener("click", () => {
    if(!selectedStudy) return;
    if(!confirm("Excluir item de estudo?")) return;
    DATA.studies = DATA.studies.filter(x => x.id!==selectedStudy);
    selectedStudy = null;
    seId.value = "";
    btnSaveStudy.disabled = true;
    btnDeleteStudy.disabled = true;
    studyStatus.textContent = "Exclu√≠do";
    save(); renderAll();
  });

  // ---------- export/import ----------
  document.getElementById("btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(DATA, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "slideops_data.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("btnExportSyncPlan").addEventListener("click", () => {
    const plan = { 
      decks: {},
      timestamp: nowISO(),
      note: "Ordem atual dos slides no SlideOps. Execute scripts/sync-slides-from-slideops.js para sincronizar com ficheiros HTML."
    };
    for(const deck of ["GRADE", "OSTEO"]) {
      const slides = getDeckSlides(deck);
      plan.decks[deck] = slides.map((s, idx) => ({
        num: s.num,
        key: s.key,
        title: s.title || "",
        position: idx + 1
      }));
    }
    const blob = new Blob([JSON.stringify(plan, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "slideops_sync_plan.json";
    a.click();
    URL.revokeObjectURL(a.href);
    saveStatus.textContent = "Plano de sincroniza√ß√£o exportado ‚úî";
  });

  document.getElementById("fileImport").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if(!f) return;
    const txt = await f.text();
    try{
      const parsed = upgrade(JSON.parse(txt));
      DATA = parsed;
      save();
      clearEditor();
      renderAll();
      alert("Import OK.");
    }catch{
      alert("Falha ao importar. JSON inv√°lido?");
    }
    ev.target.value = "";
  });

  // file linking controls
  const btnOpenData = document.getElementById("btnOpenData");
  const btnCreateData = document.getElementById("btnCreateData");
  const btnSaveData = document.getElementById("btnSaveData");
  const btnDisconnect = document.getElementById("btnDisconnect");
  const chkAutoSave = document.getElementById("chkAutoSave");

  chkAutoSave.addEventListener("change", () => {
    autoSaveFile = chkAutoSave.checked;
    setFileStatus(fileHandle ? `Vinculado: ${fileHandle.name} ‚Ä¢ auto-save ${autoSaveFile?"on":"off"}` : "Sem arquivo vinculado.");
  });

  const enableFileButtons = (linked) => {
    btnSaveData.disabled = !linked;
    btnDisconnect.disabled = !linked;
  };

  const readFromHandle = async (handle) => {
    const file = await handle.getFile();
    const txt = await file.text();
    const parsed = upgrade(JSON.parse(txt || "{}"));
    return parsed;
  };

  btnOpenData.addEventListener("click", async () => {
    if(!supportsFSA()){
      alert("Seu navegador n√£o suporta vincular arquivo. Use Export/Import (Chrome/Edge recomendado).");
      return;
    }
    try{
      const [handle] = await window.showOpenFilePicker({
        types: [{description: "JSON", accept: {"application/json": [".json"]}}],
        multiple: false
      });
      const parsed = await readFromHandle(handle);
      fileHandle = handle;
      DATA = parsed;
      save();
      clearEditor();
      renderAll();
      enableFileButtons(true);
      setFileStatus(`Vinculado: ${fileHandle.name} ‚Ä¢ carregado`);
      updateFileIndicator('connected', `üü¢ ${fileHandle.name}`);
    }catch(err){
      // user cancel
    }
  });

  btnCreateData.addEventListener("click", async () => {
    if(!supportsFSA()){
      alert("Seu navegador n√£o suporta criar/vincular arquivo. Use Export/Import (Chrome/Edge recomendado).");
      return;
    }
    try{
      const handle = await window.showSaveFilePicker({
        suggestedName: "slideops_data.json",
        types: [{description: "JSON", accept: {"application/json": [".json"]}}],
      });
      fileHandle = handle;
      enableFileButtons(true);
      setFileStatus(`Vinculado: ${fileHandle.name} ‚Ä¢ criado`);
      updateFileIndicator('connected', `üü¢ ${fileHandle.name}`);
      await writeToLinkedFile();
    }catch(err){
      // cancel
    }
  });

  btnSaveData.addEventListener("click", async () => {
    await writeToLinkedFile();
  });

  btnDisconnect.addEventListener("click", () => {
    fileHandle = null;
    enableFileButtons(false);
    setFileStatus("Sem arquivo vinculado.");
    updateFileIndicator('disconnected', 'Sem arquivo');
  });

  // init
  clearEditor();
  enableFileButtons(false);
  setFileStatus(supportsFSA() ? "Sem arquivo vinculado." : "Navegador sem File System Access (use Export/Import).");
  updateFileIndicator('disconnected', 'Sem arquivo');
  // default: mostrar por aula (GRADE) tanto em Slides quanto em Estudo
  try{ setDeckSubtab("slides","GRADE"); }catch{}
  try{ setDeckSubtab("study","GRADE"); }catch{}
  renderAll();
})();
</script>
</body>
</html>
